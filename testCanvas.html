<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SVG Raster Capture (clone-and-capture)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 20px;
      }
      #svgContainer {
        background-color: #eee;
        width: 200px;
        height: 230px;
        position: relative;
        border: 1px dashed green;
        overflow: visible;
        margin-bottom: 20px;
      }
      .toggle-group {
        margin-bottom: 12px;
      }
      button {
        padding: 8px 12px;
        background-color: #0078d4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      button:hover {
        background-color: #0063b1;
      }
      #resultImageContainer canvas {
        display: block;
        max-width: 100%;
        border: 1px solid #ddd;
        margin-top: 12px;
      }
      #notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #107c10;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>SVG Raster Capture (clone-and-capture)</h1>

    <div class="toggle-group">
      <label
        ><input type="checkbox" id="toggleForeign" checked /> Use
        <code>foreignObjectRendering</code></label
      >
    </div>

    <div id="svgContainer">
      <svg
        id="topCircle"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        style="
          fill: #ebebeb;
          stroke: #2e2e2e;
          stroke-width: 1px;
          position: absolute;
          left: -0.89%;
          top: 0.92%;
          width: 100%;
          height: 37%;
          overflow: visible;
        "
      >
        <circle cx="50" cy="50" r="48"></circle>
      </svg>
      <svg
        id="bottomCircle"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        style="
          fill: #ebebeb;
          stroke: #2e2e2e;
          stroke-width: 1px;
          position: absolute;
          left: -0.89%;
          top: 63.58%;
          width: 100%;
          height: 37%;
          overflow: visible;
        "
      >
        <circle cx="50" cy="50" r="48"></circle>
      </svg>
      <svg
        id="middleRect"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        style="
          fill: #ebebeb;
          stroke: #2e2e2e;
          stroke-width: 1px;
          position: absolute;
          left: -0.01%;
          top: 17.51%;
          width: 98.29%;
          height: 65.78%;
          overflow: visible;
        "
      >
        <rect x="1" y="1" width="98" height="98"></rect>
      </svg>
    </div>

    <button onclick="captureWithHtml2Canvas()">
      Capture as PNG (html2canvas)
    </button>
    <div id="resultImageContainer"></div>
    <div id="notification"></div>

    <script>
      function captureWithHtml2Canvas() {
        const useForeign = document.getElementById("toggleForeign").checked;
        const orig = document.getElementById("svgContainer");
        const output = document.getElementById("resultImageContainer");
        output.innerHTML = "";

        // 1) Patch SVGs so they serialize correctly
        Array.from(orig.querySelectorAll("svg")).forEach((svg) => {
          const cs = getComputedStyle(svg);
          const toPx = (v, base) =>
            v.endsWith("%") ? (parseFloat(v) / 100) * base : parseFloat(v);
          const W = toPx(cs.width, orig.clientWidth);
          const H = toPx(cs.height, orig.clientHeight);
          const L = toPx(cs.left, orig.clientWidth);
          const T = toPx(cs.top, orig.clientHeight);

          svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
          svg.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");
          svg.setAttribute("width", W);
          svg.setAttribute("height", H);
          Object.assign(svg.style, {
            position: "absolute",
            left: `${L}px`,
            top: `${T}px`,
            width: `${W}px`,
            height: `${H}px`,
            overflow: "visible",
            fill: cs.fill,
            stroke: cs.stroke,
            strokeWidth: cs.strokeWidth,
          });
        });

        // 2) Clone container at 0,0 to isolate
        const clone = orig.cloneNode(true);
        Object.assign(clone.style, {
          position: "absolute",
          top: "0",
          left: "0",
          margin: "0",
          overflow: "visible",
          zIndex: 9999,
          backgroundColor: getComputedStyle(orig).backgroundColor,
        });
        document.body.appendChild(clone);

        // 3) Capture
        html2canvas(clone, {
          allowTaint: true,
          useCORS: true,
          scale: window.devicePixelRatio || 1,
          foreignObjectRendering: useForeign,
          logging: true,
        })
          .then((canvas) => {
            output.appendChild(canvas);
            showNotification(
              `PNG capture complete (foreignObjectRendering=${useForeign})`
            );
          })
          .catch((err) => {
            console.error(err);
            output.innerHTML =
              '<p style="color:red">Error capturing with html2canvas.</p>';
          })
          .finally(() => document.body.removeChild(clone));
      }

      function showNotification(msg) {
        const n = document.getElementById("notification");
        n.textContent = msg;
        n.style.display = "block";
        setTimeout(() => (n.style.display = "none"), 2000);
      }
    </script>
  </body>
</html>
