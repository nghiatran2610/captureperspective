<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SVG Raster Capture with html2canvas - Improved</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      /* ... your existing CSS ... */
      body {
        font-family: system-ui, sans-serif;
        margin: 20px;
        line-height: 1.6;
      }
      #svgContainer {
        background-color: #eee;
        width: 200px;
        height: 230px;
        position: relative;
        border: 1px dashed green;
        overflow: visible;
        margin-bottom: 20px;
      }
      button {
        padding: 10px 15px;
        background-color: #0078d4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      button:hover {
        background-color: #0063b1;
      }
      #output {
        margin-top: 20px;
      }
      #resultImageContainer img {
        max-width: 100%;
        border: 1px solid #ddd;
        margin-top: 10px;
      }
      #notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #107c10;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>SVG Raster Capture with html2canvas - Improved</h1>
    <div id="svgContainer">
      <svg
        id="topCircle"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        style="
          fill: rgb(235, 235, 235);
          stroke: rgb(46, 46, 46);
          stroke-width: 1px;
          position: absolute;
          left: -0.89%;
          top: 0.92%;
          width: 100%;
          height: 37%;
          overflow: visible;
        "
      >
        <circle cx="50" cy="50" r="48"></circle>
      </svg>
      <svg
        id="bottomCircle"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        style="
          fill: rgb(235, 235, 235);
          stroke: rgb(46, 46, 46);
          stroke-width: 1px;
          position: absolute;
          left: -0.89%;
          top: 63.58%;
          width: 100%;
          height: 37%;
          overflow: visible;
        "
      >
        <circle cx="50" cy="50" r="48"></circle>
      </svg>
      <svg
        id="middleRect"
        viewBox="0 0 100 100"
        preserveAspectRatio="none"
        style="
          fill: rgb(235, 235, 235);
          stroke: rgb(46, 46, 46);
          stroke-width: 1px;
          position: absolute;
          left: -0.01%;
          top: 17.51%;
          width: 98.29%;
          height: 65.78%;
          overflow: visible;
        "
      >
        <rect x="1" y="1" width="98" height="98"></rect>
      </svg>
    </div>
    <button onclick="captureWithHtml2Canvas()">
      Capture as PNG (html2canvas)
    </button>
    <div id="output"><div id="resultImageContainer"></div></div>
    <div id="notification">PNG capture complete!</div>

    <script>
      function captureWithHtml2Canvas() {
        const elementToCapture = document.getElementById("svgContainer");
        const outputDiv = document.getElementById("resultImageContainer");
        outputDiv.innerHTML = "";

        if (typeof html2canvas !== "function") {
          outputDiv.innerHTML =
            '<p style="color: red;">Error: html2canvas library not found.</p>';
          return;
        }

        const svgElements = elementToCapture.querySelectorAll("svg");
        const originalStyles = [];
        const containerWidth = elementToCapture.offsetWidth;
        const containerHeight = elementToCapture.offsetHeight;

        // Temporarily set explicit pixel sizes for SVGs
        svgElements.forEach((svg) => {
          originalStyles.push({ el: svg, style: svg.getAttribute("style") }); // Save original inline style

          const computedStyle = getComputedStyle(svg);
          let newStyles = `position: absolute; overflow: visible;`; // Keep essential fixed styles
          newStyles += `fill: ${computedStyle.fill}; stroke: ${computedStyle.stroke}; stroke-width: ${computedStyle.strokeWidth};`;

          const parseValue = (value, base) => {
            if (value.includes("%")) {
              return (parseFloat(value) / 100) * base;
            }
            return parseFloat(value); // Assumes px or unitless already
          };

          const leftPx = parseValue(computedStyle.left, containerWidth);
          const topPx = parseValue(computedStyle.top, containerHeight);
          const widthPx = parseValue(computedStyle.width, containerWidth);
          const heightPx = parseValue(computedStyle.height, containerHeight);

          newStyles += `left: ${leftPx}px; top: ${topPx}px; width: ${widthPx}px; height: ${heightPx}px;`;
          svg.setAttribute("style", newStyles);
        });

        const options = {
          allowTaint: true,
          useCORS: true,
          backgroundColor: getComputedStyle(elementToCapture).backgroundColor, // Use actual BG
          scale: window.devicePixelRatio || 1,
          logging: true,
          // Explicitly set width and height for html2canvas based on the target element
          width: containerWidth,
          height: containerHeight,
          // windowWidth/Height might not be necessary if capturing a specific div
          // and can sometimes cause issues if not set thoughtfully.
          // Try without them first, or set them to containerWidth/Height as well.
          // windowWidth: containerWidth,
          // windowHeight: containerHeight,
        };

        html2canvas(elementToCapture, options)
          .then(function (canvas) {
            const img = new Image();
            img.src = canvas.toDataURL("image/png");
            outputDiv.appendChild(img);
            showNotification("PNG capture complete (html2canvas)!");
          })
          .catch(function (error) {
            console.error("Error capturing with html2canvas:", error);
            outputDiv.innerHTML =
              '<p style="color: red;">Error capturing with html2canvas.</p>';
          })
          .finally(() => {
            // Revert styles
            originalStyles.forEach((item) => {
              if (item.style) item.el.setAttribute("style", item.style);
              else item.el.removeAttribute("style"); // If it had no style attr initially
            });
          });
      }

      function showNotification(message) {
        // ... (showNotification function unchanged) ...
        const notification = document.getElementById("notification");
        notification.textContent = message || "Capture complete!";
        notification.style.display = "block";
        setTimeout(function () {
          notification.style.display = "none";
        }, 3000);
      }
    </script>
  </body>
</html>
